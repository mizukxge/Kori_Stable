generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin Users - Authentication & Authorization
model AdminUser {
  id       String  @id @default(cuid())
  email    String  @unique
  password String // Hashed password
  name     String
  role     Role    @default(USER)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions          Session[]
  rightsPresets     RightsPreset[]
  galleries         Gallery[]
  proposals         Proposal[]
  contractTemplates ContractTemplate[]
  contracts         Contract[]
  invoices          Invoice[]
  reconciliations   Reconciliation[]
  releases          Release[]
  auditLogs         AuditLog[]

  assets Asset[]

  @@map("admin_users")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
}

// Sessions - User authentication sessions
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  user AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// Clients - Customer/Client records
model Client {
  id      String       @id @default(cuid())
  name    String
  email   String       @unique
  phone   String?
  company String?
  status  ClientStatus @default(ACTIVE)

  // Address information
  address String?
  city    String?
  state   String?
  zipCode String?
  country String? @default("US")

  // Metadata
  notes String?
  tags  String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]

  assets    Asset[]
  releases  Release[]
  galleries Gallery[]
  proposals Proposal[]
  contracts Contract[]
  invoices  Invoice[]

  @@index([email])
  @@index([status])
  @@map("clients")
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PENDING
  ARCHIVED
}

// Audit Log - Activity tracking
model AuditLog {
  id         String  @id @default(cuid())
  action     String // e.g., "CREATE", "UPDATE", "DELETE", "LOGIN"
  entityType String // e.g., "Client", "AdminUser", "Session"
  entityId   String? // ID of the affected entity

  userId   String? // Who performed the action
  clientId String? // Related client (if applicable)

  // Details
  changes   Json? // Store before/after state
  metadata  Json? // Additional context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  user   AdminUser? @relation(fields: [userId], references: [id], onDelete: SetNull)
  client Client?    @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([clientId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

// Assets - Uploaded files (RAW/EDIT/VIDEO)
model Asset {
  id         String        @id @default(cuid())
  filename   String // Original filename
  storedName String        @unique // Unique filename on disk
  filepath   String // Full path to file
  mimeType   String // MIME type (image/jpeg, video/mp4, etc.)
  size       BigInt // File size in bytes
  checksum   String        @unique // SHA256 hash
  category   AssetCategory

  // Metadata
  width    Int?
  height   Int?
  duration Float? // Video duration in seconds
  metadata Json? // EXIF and other metadata

  // Associations
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  uploadedBy     String
  uploadedByUser AdminUser @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  galleries GalleryAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([uploadedBy])
  @@index([category])
  @@index([checksum])
  @@map("assets")
}

enum AssetCategory {
  RAW
  EDIT
  VIDEO
}

// Rights Presets - Copyright and usage rights templates
model RightsPreset {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?

  // Copyright fields
  creator         String
  copyrightNotice String
  usageRights     String
  creditLine      String?
  instructions    String?

  // Location defaults
  city    String?
  state   String?
  country String?

  // Tags
  keywords String[] @default([])

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdBy     String
  createdByUser AdminUser @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("rights_presets")
}

// Model/Property Releases
model Release {
  id          String      @id @default(cuid())
  type        ReleaseType
  releaseName String // Name of person or property
  releaseDate DateTime?
  expiryDate  DateTime?

  // File storage
  documentPath String? // Path to signed release document
  notes        String?

  // Associations
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  uploadedBy     String
  uploadedByUser AdminUser @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([type])
  @@map("releases")
}

enum ReleaseType {
  MODEL
  PROPERTY
}

// Galleries - Public shareable collections
model Gallery {
  id          String    @id @default(cuid())
  token       String    @unique // URL token for public access
  name        String
  description String?
  password    String? // Hashed password (optional)
  expiresAt   DateTime? // Gallery expiration
  isActive    Boolean   @default(true)

  // Associations
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  createdBy     String
  createdByUser AdminUser @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  // Assets in this gallery (many-to-many)
  assets GalleryAsset[]

  // Stats
  viewCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([clientId])
  @@index([expiresAt])
  @@map("galleries")
}

// Join table for Gallery <-> Asset many-to-many relationship
model GalleryAsset {
  id        String @id @default(cuid())
  galleryId String
  assetId   String
  position  Int    @default(0) // Order in gallery

  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  asset   Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([galleryId, assetId])
  @@index([galleryId])
  @@index([assetId])
  @@map("gallery_assets")
}

// Proposals - Client proposals with e-signature
model Proposal {
  id             String  @id @default(cuid())
  proposalNumber String  @unique // e.g., PROP-2025-001
  title          String
  description    String?

  // Client association
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Pricing
  subtotal  Decimal @db.Decimal(10, 2)
  taxRate   Decimal @default(0) @db.Decimal(5, 2)
  taxAmount Decimal @default(0) @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)
  currency  String  @default("USD")

  // Terms
  terms      String? // Terms and conditions
  expiresAt  DateTime? // Proposal expiration
  validUntil String? // Human-readable validity

  // Status
  status     ProposalStatus @default(DRAFT)
  sentAt     DateTime?
  viewedAt   DateTime?
  acceptedAt DateTime?
  declinedAt DateTime?

  // E-signature tracking
  signatureIP    String?
  signatureAgent String? // User agent string
  otpCode        String? // Current OTP for acceptance
  otpExpiresAt   DateTime? // OTP expiration
  otpAttempts    Int       @default(0)

  // Line items
  items ProposalItem[]

  // Contract relationship
  contract Contract?

  // Metadata
  notes   String? // Internal notes
  pdfPath String? // Generated PDF location

  createdBy     String
  createdByUser AdminUser @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([status])
  @@index([proposalNumber])
  @@map("proposals")
}

// Proposal Line Items
model ProposalItem {
  id         String   @id @default(cuid())
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  position    Int     @default(0) // Order in proposal
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2) // quantity * unitPrice

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([proposalId])
  @@map("proposal_items")
}

enum ProposalStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  DECLINED
  EXPIRED
}

// Contract Templates - Reusable contract templates with variables
model ContractTemplate {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  content     String  @db.Text // Template content with {{variables}}

  // Variables metadata
  variables Json? // List of available variables with descriptions

  // Status
  isActive Boolean @default(true)
  version  Int     @default(1)

  // Generated contracts
  contracts Contract[]

  createdBy     String
  createdByUser AdminUser @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("contract_templates")
}

// Contracts - Generated contracts from templates
model Contract {
  id             String @id @default(cuid())
  contractNumber String @unique // e.g., CONT-2025-001
  title          String

  // Template reference
  templateId      String
  template        ContractTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  templateVersion Int              @default(1)

  // Generated content
  content   String @db.Text // Final content with variables replaced
  variables Json // Actual variable values used

  // Associations
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  proposalId String?   @unique
  proposal   Proposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)

  // Status
  status   ContractStatus @default(DRAFT)
  sentAt   DateTime?
  signedAt DateTime?

  // PDF
  pdfPath String?

  createdBy     String
  createdByUser AdminUser @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contractNumber])
  @@index([clientId])
  @@index([templateId])
  @@index([status])
  @@map("contracts")
}

enum ContractStatus {
  DRAFT
  SENT
  SIGNED
  EXPIRED
  CANCELLED
}

// Invoices - Client invoicing
model Invoice {
  id            String  @id @default(cuid())
  invoiceNumber String  @unique // e.g., INV-2025-001
  title         String
  description   String?

  // Client association
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Pricing
  subtotal   Decimal @db.Decimal(10, 2)
  taxRate    Decimal @default(0) @db.Decimal(5, 2)
  taxAmount  Decimal @default(0) @db.Decimal(10, 2)
  total      Decimal @db.Decimal(10, 2)
  amountPaid Decimal @default(0) @db.Decimal(10, 2)
  amountDue  Decimal @db.Decimal(10, 2)
  currency   String  @default("USD")

  // Payment terms
  dueDate      DateTime?
  paymentTerms String? // e.g., "Net 30", "Due on Receipt"
  notes        String?

  // Status
  status InvoiceStatus @default(DRAFT)
  sentAt DateTime?
  paidAt DateTime?

  // Line items and payments
  items    InvoiceItem[]
  payments Payment[]

  // PDF
  pdfPath String?

  createdBy     String
  createdByUser AdminUser @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceNumber])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// Invoice Line Items
model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  position    Int     @default(0)
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@map("invoice_items")
}

// Payments - Payment transactions
model Payment {
  id            String @id @default(cuid())
  paymentNumber String @unique // e.g., PAY-2025-001

  // Invoice association
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Payment details
  amount   Decimal       @db.Decimal(10, 2)
  currency String        @default("USD")
  method   PaymentMethod @default(BANK_TRANSFER)
  status   PaymentStatus @default(PENDING)

  // External payment processor
  stripePaymentId String? @unique
  stripeIntentId  String?

  // Metadata
  paidAt       DateTime?
  refundedAt   DateTime?
  refundAmount Decimal?  @db.Decimal(10, 2)
  notes        String?

  // Reconciliation
  reconciliation Reconciliation?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([status])
  @@index([stripePaymentId])
  @@map("payments")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  CASH
  STRIPE
  PAYPAL
  OTHER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// Bank Transactions - Imported from bank statements
model BankTransaction {
  id String @id @default(cuid())

  // Transaction details
  transactionDate DateTime
  description     String
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  reference       String? // Bank reference number

  // Bank account info
  bankAccount   String?
  accountNumber String?

  // Import metadata
  importBatch String // Group transactions by import batch
  rawData     Json? // Original CSV row for reference

  // Reconciliation
  reconciled     Boolean         @default(false)
  reconciledAt   DateTime?
  reconciliation Reconciliation?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionDate])
  @@index([amount])
  @@index([importBatch])
  @@index([reconciled])
  @@map("bank_transactions")
}

// Reconciliation - Matches between bank transactions and payments
model Reconciliation {
  id String @id @default(cuid())

  // Bank transaction
  bankTransactionId String          @unique
  bankTransaction   BankTransaction @relation(fields: [bankTransactionId], references: [id], onDelete: Cascade)

  // System payment (if matched)
  paymentId String?  @unique
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  // Matching details
  matchType     MatchType  @default(MANUAL)
  confidence    Int        @default(0) // 0-100%
  matchedBy     String? // User who confirmed match
  matchedByUser AdminUser? @relation(fields: [matchedBy], references: [id], onDelete: SetNull)

  // Status
  status ReconciliationStatus @default(PENDING)
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([matchType])
  @@map("reconciliations")
}

enum MatchType {
  AUTO_EXACT // Exact amount and date match
  AUTO_FUZZY // Fuzzy match with high confidence
  MANUAL // Manually matched by user
  SUGGESTED // System suggestion, needs confirmation
}

enum ReconciliationStatus {
  PENDING // Not yet confirmed
  CONFIRMED // Match confirmed
  REJECTED // Match rejected
  UNMATCHED // No match found
}
