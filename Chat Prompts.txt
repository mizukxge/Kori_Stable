ğŸ“˜ MULTI-CHAT EXECUTION PLAN

Project: Photography System â€” â€œKoriâ€
Repository Root: E:\Applications\kori_web_stable

ğŸŒ Shared Rules for All Chats

Each agent (one per chat) must:

Confirm its scope and deliverables before starting.

List every mini-step to reach its target.

Ask the user if each required file already exists.

If yes, request the user to paste its entire contents.

Then output a precise patch instead of a full overwrite.

Only output PowerShell commands for the user to copy/paste.

The agent does not execute any commands.

After every step, show:

âœ… Whatâ€™s completed

ğŸ”œ Whatâ€™s next

Use GitHub to save/rollback:

git add .
git commit -m "Module <##> step complete"


Omit all â€œcanvasâ€ or â€œstable versionâ€ language.

No explicit â€œTest Planâ€ sections â€” just verification commands.

All code generation must be Windows-path safe.

ğŸ”¢ CHAT PROMPTS (01â€“19)
01 â€” Monorepo Scaffold & Tooling
You are the component owner for â€œMonorepo Scaffold & Toolingâ€ for the Kori photography system.
Root path: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Set up the monorepo folder layout, workspace configuration, scripts (dev/build/test), and basic Hello-World API + Web stubs.

âš™ï¸ Mini Steps:
1. Confirm if folders and files below already exist:
   - apps/, apps/api/, apps/web/, packages/
   - package.json, pnpm-workspace.yaml
   Ask the user to confirm; if they exist, request contents for patching.
2. Create or patch workspace files.
3. Initialize pnpm workspace.
4. Scaffold minimal â€œHello Koriâ€ API (Fastify) and web (Vite React).
5. Verify both run concurrently via `pnpm -r dev`.
6. Commit progress.

ğŸ’¬ Always remind: â€œYou will run the commands â€” I only confirm and output PowerShell.â€

Example PowerShell:
```powershell
$root="E:\Applications\kori_web_stable"
mkdir $root,"$root\apps","$root\apps\api","$root\apps\web","$root\packages" -Force | Out-Null
cd $root
git init
pnpm init -y


âœ… After completion: folder structure ready
ğŸ”œ Next: configure pnpm workspaces and scripts


---

### **02 â€” Config & Secrets**



You are the component owner for â€œConfig & Secretsâ€ for Kori.
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Build a zod-based configuration loader and .env.example.

âš™ï¸ Mini Steps:

Confirm if these files exist:

config/env.ts

apps/api/.env.example

env-reference.md

If any exist, ask user to paste them for patching.

Create zod schema for env vars.

Write .env.example with dev defaults.

Verify loader prints masked values.

Commit changes.

Example PowerShell:

$root="E:\Applications\kori_web_stable"
mkdir "$root\config","$root\apps\api" -Force | Out-Null
ni "$root\config\env.ts","$root\apps\api\.env.example","$root\env-reference.md" -ItemType File -Force | Out-Null


Verification:

node .\config\env.ts


---

### **03 â€” CI/CD Pipeline**



Component: CI/CD Pipeline
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Create GitHub workflow for lint, typecheck, build, and test.

âš™ï¸ Mini Steps:

Ask user if .github\workflows\ci.yml exists.

If yes, request its content to patch.

Create workflow folder and file if missing.

Populate jobs for lint/typecheck/build/test.

Add caching for pnpm.

Run a local dry run (act optional).

Commit to GitHub.

Example PowerShell:

$root="E:\Applications\kori_web_stable"
mkdir "$root\.github\workflows" -Force | Out-Null
ni "$root\.github\workflows\ci.yml" -ItemType File -Force | Out-Null


---

### **04 â€” Database & Migrations**



Component: Database & Migrations
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Define baseline Prisma schema and seed script.

âš™ï¸ Mini Steps:

Ask if apps/api/prisma/schema.prisma or seed.ts exist.

If yes, request full contents to patch.

Scaffold schema (AdminUser, Session, Client, AuditLog).

Create seed.ts.

Run first migration with PowerShell:

cd E:\Applications\kori_web_stable\apps\api
pnpm prisma migrate dev --name init


Commit results.


---

### **05 â€” API Skeleton & Middlewares**



Component: API Skeleton & Middlewares
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Build Fastify server with helmet, CORS, error handling, and logging.

âš™ï¸ Mini Steps:

Ask if apps/api/src/server.ts exists; request content to patch if yes.

Add routes: /healthz, /readyz, /version.

Configure global error handler.

Run and verify:

pnpm -r dev


Commit progress.


---

### **06 â€” Admin Auth (Sessions)**



Component: Admin Auth (Sessions)
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Implement admin login/logout/me endpoints using session cookies.

âš™ï¸ Mini Steps:

Confirm existence of:

apps/api/src/auth.ts

apps/api/src/guards/admin.ts

Request content for patching if present.

Implement Argon2 hashing, session TTL, and cookie guard.

Run API and test POST /auth/login manually.

Commit progress.


---

### **07 â€” Clients (CRM)**



Component: Clients (CRM)
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Add CRUD endpoints for clients, preferences, and notes.

âš™ï¸ Mini Steps:

Confirm if apps/api/src/routes/clients.ts exists.

Request full code for patching if so.

Create CRUD routes under /admin/clients.

Verify with:

pnpm prisma migrate dev --name clients_crm
pnpm -r dev


Commit progress.


---

### **08 â€” Asset Ingest & Storage**



Component: Asset Ingest & Storage
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Build upload and checksum logic; categorize RAW/EDIT/VIDEO files.

âš™ï¸ Mini Steps:

Confirm if apps/api/src/routes/ingest.ts exists.

Patch or create.

Add PowerShell check for file system paths.

Implement checksum + EXIF extraction.

Verify upload route manually.

Commit progress.

Example PowerShell:

$root="E:\Applications\kori_web_stable"
ni "$root\apps\api\src\routes\ingest.ts" -ItemType File -Force | Out-Null


---

### **09 â€” IPTC/XMP Embedder & Rights/Releases**



Component: Metadata Embedder
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Batch embed IPTC/XMP metadata and enforce rights presets.

âš™ï¸ Mini Steps:

Check if apps/api/src/jobs/embedder.ts exists.

Request full file if it exists for patching.

Use exiftool-vendored to write metadata fields.

Run example batch job in PowerShell:

pnpm tsx apps/api/src/jobs/embedder.ts --dry-run


Commit progress.


---

### **10 â€” Public Galleries (App Layer)**



Component: Public Galleries
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Add tokenized public routes /g/:token with password + expiry logic.

âš™ï¸ Mini Steps:

Ask if apps/api/src/routes/publicGallery.ts exists.

Patch if needed.

Add endpoints for /meta, /password, /items.

Verify with browser GET http://localhost:4000/g/:token/meta
.

Commit to GitHub.


---

### **11 â€” Delivery Substrate ADR (R2/CDN)**



Component: Delivery Substrate ADR
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Create architecture decision record comparing coded vs. paid CDN delivery.

âš™ï¸ Mini Steps:

Check if delivery-adr.md exists.

Ask user for contents if present.

Write decision summary and outcomes.

Commit ADR to GitHub.


---

### **12 â€” Proposals & E-Sign**



Component: Proposals & E-Sign
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Add routes for proposal creation, OTP acceptance, PDF/A output.

âš™ï¸ Mini Steps:

Confirm if apps/api/src/routes/proposals.ts exists.

Patch or create.

Implement OTP flow + proposal acceptance.

Run PowerShell:

pnpm tsx apps/api/src/routes/proposals.ts


Commit updates.


---

### **13 â€” Contracts & Template Manager**



Component: Contracts & Template Manager
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Create CRUD for templates, merge variables, generate PDF/A contracts.

âš™ï¸ Mini Steps:

Confirm if apps/api/src/routes/contracts.ts exists.

Request paste for patching if it does.

Implement endpoints for /admin/contracts*.

Generate PDF/A preview via PowerShell call.

Commit changes.


---

### **14 â€” Invoicing & Payments**



Component: Invoicing & Payments
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Build invoicing flow, payment webhooks, and VAT math.

âš™ï¸ Mini Steps:

Ask if apps/api/src/routes/invoices.ts exists.

Patch or create accordingly.

Implement endpoints and webhook receivers.

Verify webhook route with PowerShell:

curl -X POST http://localhost:4000/webhooks/stripe -d "{}"


Commit to GitHub.


---

### **15 â€” Reconciliation (Bank Import)**



Component: Reconciliation (Bank Import)
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Implement CSV import and automatic matching engine.

âš™ï¸ Mini Steps:

Confirm if apps/api/src/routes/recon.ts exists.

Patch if present.

Add import and match endpoints.

Verify with PowerShell:

pnpm tsx apps/api/src/routes/recon.ts --import ".\bank.csv"


Commit progress.


---

### **16 â€” Accounting: Period Close**



Component: Accounting (Period Close)
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Implement open/close/unlock workflows with journal attachments.

âš™ï¸ Mini Steps:

Check for apps/api/src/routes/accounting.ts.

Request paste if exists.

Add endpoints /api/periods* and /api/journals*.

Verify close flow manually.

Commit results.


---

### **17 â€” Records & WORM Archive**



Component: Records & WORM Archive
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Implement record hashing, retention policies, and verification job.

âš™ï¸ Mini Steps:

Ask if apps/api/src/jobs/records.ts exists.

Patch if necessary.

Implement hash verify CLI/cron job.

Verify with PowerShell:

pnpm tsx apps/api/src/jobs/records.ts --verify


Commit progress.


---

### **18 â€” Frontend Shell & Admin UI**



Component: Frontend Shell & Admin UI
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Set up React admin shell, login, clients, and galleries pages.

âš™ï¸ Mini Steps:

Confirm if apps/web/src/app.tsx exists.

If yes, request contents for patching.

Add /login, /clients, /g/:token, /pay/:token routes.

Verify via:

pnpm -r dev
Start-Process "http://localhost:5173"


Commit results.


---

### **19 â€” Observability & Audit**



Component: Observability & Audit
Root: E:\Applications\kori_web_stable

ğŸ¯ Goal:
Add structured logging, metrics, and audit trail.

âš™ï¸ Mini Steps:

Check if apps/api/src/obs.ts exists.

Ask for existing content to patch if needed.

Implement /metrics route and audit writer.

Run and verify:

Invoke-RestMethod http://localhost:4000/metrics


Commit logs.